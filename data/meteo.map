<!DOCTYPE html>
<html>
<head>
    <title>Meteo</title>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css" />
    <style type="text/css">
      html, body, #map {
          width: 100%;
          height: 100%;
          margin: 0;
      }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="http://leafletjs.com/dist/leaflet.js"></script>
    <script src="http://astropedia.free.fr/previsat/html/leaflet-openweathermap.js"></script>
    <link rel="stylesheet" type="text/css" href="http://astropedia.free.fr/previsat/html/leaflet-openweathermap.css" />
    <script>

        function getLocalLanguage() {
            var lang = null;

            // 1. try to read URL parameter 'lang'
            var qs = window.location.search;
            if (qs) {
                if (qs.substring(0, 1) == '?') {
                    qs = qs.substring(1)
                }
                var params = qs.split('&')
                for(var i = 0; i < params.length; i++) {
                    var keyvalue = params[i].split('=');
                    if (keyvalue[0] == 'lang') {
                        lang = keyvalue[1];
                        break;
                    }
                }
            }

            // 2. try to get browser or system language
            if (!lang) {
                var tmp = window.navigator.userLanguage || window.navigator.language;
                lang = tmp.split('-')[0];
            }

            // Use only supported languages, defaults to 'en'
            if (lang != 'en' && lang != 'fr') {
                lang = 'en';
            }
            return lang;
        }

        function traduction(key, lang) {
            var listeMots = {
                en: {
                    clouds: 'Clouds',
                    city: 'Cities',
                    precipitation: 'Precipitation',
                    rain: 'Rain',
                    snow: 'Snow',
                    temp: 'Temperature',
                    windspeed: 'Wind Speed',
                    pressure: 'Pressure',
                    presscont: 'Pressure Contour'
                },

                fr: {
                    clouds: 'Nuages',
                    city: 'Villes',
                    clouds: 'Nuages',
                    precipitation: 'Précipitations',
                    rain: 'Pluie',
                    snow: 'Neige',
                    temp: 'Température',
                    windspeed: 'Vitesse du vent',
                    pressure: 'Pression de l\'air',
                    presscont: 'Isobares'
                }
            };

            if (typeof listeMots[lang] != 'undefined'
                    && typeof listeMots[lang][key] != 'undefined') {
                return  listeMots[lang][key];
            }
            return key;
        }

        var map;

        var mapquestUrl = "http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",
            mapquestSubDomains = ["otile1","otile2","otile3","otile4"],
            mapquestAttrib = 'Data, imagery and map information provided by ' + '<a>MapQuest</a>, ' + '<a>OpenStreetMap</a> and ' + 'Map: <a>CC-BY-SA</a>',
            mapquest = new L.TileLayer(mapquestUrl, {maxZoom: 18, attribution: mapquestAttrib, subdomains: mapquestSubDomains});

        var langue = getLocalLanguage();

        var clouds = L.OWM.clouds({opacity: 0.8});
        var precipitation = L.OWM.precipitation( {opacity: 0.5} );
        var rain = L.OWM.rain({opacity: 0.5});
        var snow = L.OWM.snow({opacity: 0.5});
        var pressure = L.OWM.pressure({opacity: 0.4});
        var pressurecntr = L.OWM.pressureContour({opacity: 0.5});
        var temp = L.OWM.temperature({opacity: 0.5});
        var wind = L.OWM.wind({opacity: 0.5});

        var OWM_API_KEY = '06aac0fd4ba239a20d824ef89602f311';
        var city = L.OWM.current({intervall: 15, imageLoadingUrl: 'http://astropedia.free.fr/previsat/html/owmloading.gif', lang: langue, minZoom: 5,
            appId: OWM_API_KEY});

        map = L.map('map', {
            center: new L.LatLng(LATITUDE_CENTRE, LONGITUDE_CENTRE), zoom: 9,
            layers: [mapquest, clouds, city]
        });

        var overlayMaps = {};
        overlayMaps[traduction('clouds', langue)] = clouds;
        overlayMaps[traduction('city', langue)] = city;
        overlayMaps[traduction('precipitation', langue)] = precipitation;
        overlayMaps[traduction('rain', langue)] = rain;
        overlayMaps[traduction('snow', langue)] = snow;
        overlayMaps[traduction('temp', langue)] = temp;
        overlayMaps[traduction('windspeed', langue)] = wind;
        overlayMaps[traduction('pressure', langue)] = pressure;
        overlayMaps[traduction('presscont', langue)] = pressurecntr;

        var layerControl = L.control.layers("", overlayMaps, {collapsed: false}).addTo(map);

    </script>
</body>
</html>
